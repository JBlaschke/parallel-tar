name: Build & attach Rust binaries (multi-platform)

on:
  push:
    tags:
      - "v*"
      # If you want *any* tag to trigger, replace the above with:
      # - "*"

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.asset_target }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # -------------------------
          # Linux (glibc baseline 2.32) - uses zigbuild
          # Produces artifacts that should run on systems with glibc >= 2.32
          # -------------------------
          - runs_on: ubuntu-24.04
            rust_target: x86_64-unknown-linux-gnu
            build_target: x86_64-unknown-linux-gnu.2.32
            asset_target: x86_64-unknown-linux-gnu.2.32
            builder: zigbuild
            archive_ext: tar.gz

          - runs_on: ubuntu-24.04-arm
            rust_target: aarch64-unknown-linux-gnu
            build_target: aarch64-unknown-linux-gnu.2.32
            asset_target: aarch64-unknown-linux-gnu.2.32
            builder: zigbuild
            archive_ext: tar.gz

          # -------------------------
          # Linux (musl) - uses zigbuild
          # Often fully static; avoids glibc compatibility issues entirely
          # -------------------------
          - runs_on: ubuntu-24.04
            rust_target: x86_64-unknown-linux-musl
            build_target: x86_64-unknown-linux-musl
            asset_target: x86_64-unknown-linux-musl
            builder: zigbuild
            archive_ext: tar.gz

          - runs_on: ubuntu-24.04-arm
            rust_target: aarch64-unknown-linux-musl
            build_target: aarch64-unknown-linux-musl
            asset_target: aarch64-unknown-linux-musl
            builder: zigbuild
            archive_ext: tar.gz

          # -------------------------
          # Windows (native cargo build)
          # -------------------------
          - runs_on: windows-2022
            rust_target: x86_64-pc-windows-msvc
            build_target: x86_64-pc-windows-msvc
            asset_target: x86_64-pc-windows-msvc
            builder: cargo
            archive_ext: zip

          - runs_on: windows-11-arm
            rust_target: aarch64-pc-windows-msvc
            build_target: aarch64-pc-windows-msvc
            asset_target: aarch64-pc-windows-msvc
            builder: cargo
            archive_ext: zip

          # -------------------------
          # macOS (native cargo build)
          # -------------------------
          - runs_on: macos-15-intel
            rust_target: x86_64-apple-darwin
            build_target: x86_64-apple-darwin
            asset_target: x86_64-apple-darwin
            builder: cargo
            archive_ext: tar.gz

          - runs_on: macos-15
            rust_target: aarch64-apple-darwin
            build_target: aarch64-apple-darwin
            asset_target: aarch64-apple-darwin
            builder: cargo
            archive_ext: tar.gz

    runs-on: ${{ matrix.runs_on }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python (for packaging)
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: release-${{ matrix.asset_target }}

      # Linux-only: install Zig + cargo-zigbuild
      - name: Install Zig
        if: matrix.builder == 'zigbuild'
        uses: mlugg/setup-zig@v1

      - name: Install cargo-zigbuild
        if: matrix.builder == 'zigbuild'
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-zigbuild

      - name: Build (release)
        if: matrix.builder == 'cargo'
        run: cargo build --release --locked --bins --target ${{ matrix.build_target }}

      - name: Build (release, zigbuild)
        if: matrix.builder == 'zigbuild'
        run: cargo zigbuild --release --locked --bins --target ${{ matrix.build_target }}

      - name: Package archive (all binaries)
        shell: bash
        env:
          BUILD_TARGET: ${{ matrix.build_target }}
          ASSET_TARGET: ${{ matrix.asset_target }}
          TAG: ${{ github.ref_name }}
          ARCHIVE_EXT: ${{ matrix.archive_ext }}
          # Optional override (repo variable): "parallel-tar parallel-idx view-idx"
          BIN_NAMES: ${{ vars.BIN_NAMES }}
        run: |
          set -euo pipefail

          python - <<'PY'
          import json, os, pathlib, shutil, subprocess, tarfile, zipfile, re

          build_target = os.environ["BUILD_TARGET"]
          asset_target = os.environ["ASSET_TARGET"]
          tag = os.environ["TAG"]
          archive_ext = os.environ["ARCHIVE_EXT"]
          bin_names_override = (os.environ.get("BIN_NAMES") or "").strip()

          meta = json.loads(subprocess.check_output(["cargo", "metadata", "--no-deps", "--format-version", "1"]))

          # Select the root package (best effort)
          root_manifest = pathlib.Path("Cargo.toml").resolve()
          root_pkg = next(
              (p for p in meta["packages"] if pathlib.Path(p["manifest_path"]).resolve() == root_manifest),
              None
          )
          if root_pkg is None:
              default_members = meta.get("workspace_default_members") or meta.get("workspace_members")
              root_id = default_members[0]
              root_pkg = next(p for p in meta["packages"] if p["id"] == root_id)

          # Determine bin targets
          bin_targets = [t for t in root_pkg.get("targets", []) if "bin" in t.get("kind", [])]
          detected_bins = [t["name"] for t in bin_targets]

          if bin_names_override:
              bin_names = [x for x in re.split(r"[,\s]+", bin_names_override) if x]
          else:
              bin_names = detected_bins

          if not bin_names:
              raise SystemExit("No bin targets found to package. (Do you only have a library?)")

          exe = ".exe" if asset_target.endswith("windows-msvc") else ""

          pkg_name = root_pkg["name"]
          out_name = f"{pkg_name}-{tag}-{asset_target}"

          dist = pathlib.Path("dist") / out_name
          if dist.exists():
              shutil.rmtree(dist)
          dist.mkdir(parents=True)

          missing = []
          for name in bin_names:
              built = pathlib.Path("target") / build_target / "release" / f"{name}{exe}"
              if not built.exists():
                  missing.append(str(built))
                  continue
              shutil.copy2(built, dist / f"{name}{exe}")

          if missing:
              raise SystemExit(
                  "Some expected binaries were not found after build:\n"
                  + "\n".join(f"  - {m}" for m in missing)
                  + "\n\nDetected bin targets from cargo metadata:\n"
                  + "\n".join(f"  - {b}" for b in detected_bins)
                  + "\n\nTip: ensure the build step uses `--bins` and the packaging BUILD_TARGET matches the build target."
              )

          # Copy common docs if present
          for fn in ("README.md", "README.txt", "LICENSE", "LICENSE.md", "COPYING"):
              p = pathlib.Path(fn)
              if p.exists():
                  shutil.copy2(p, dist / p.name)

          archive = pathlib.Path(f"{out_name}.{archive_ext}")
          if archive_ext == "zip":
              with zipfile.ZipFile(archive, "w", compression=zipfile.ZIP_DEFLATED) as z:
                  for file in dist.rglob("*"):
                      if file.is_file():
                          z.write(file, arcname=f"{out_name}/{file.relative_to(dist).as_posix()}")
          elif archive_ext == "tar.gz":
              with tarfile.open(archive, "w:gz") as t:
                  t.add(dist, arcname=out_name)
          else:
              raise SystemExit(f"Unsupported archive_ext={archive_ext}")

          print(f"Packaged bins: {', '.join(bin_names)}")
          print(f"Created: {archive}")
          PY

      - name: Upload artifact (for release job)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_target }}
          path: |
            *.tar.gz
            *.zip
          if-no-files-found: error

  release:
    name: Attach artifacts to GitHub Release
    needs: build
    runs-on: ubuntu-24.04

    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
          generate_release_notes: true
          fail_on_unmatched_files: true
